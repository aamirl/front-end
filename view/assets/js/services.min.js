var services=angular.module("services",[]);services.service("getTemplate",["$http","$q","cacheService","apiCall",function(e,t,n,r){this.get=function(e){var t={category:e.data.data.line.category.data.toString()};return req={url:"9000/products/p/template",data:t},r.getapi(req).then(function(e){return n.setData(t.category,e.success.data),e.success.data},function(e){console.log("Server Error")})}}]),services.filter("tweetLinky",["$filter",function(e){return function(t,n){if(!t)return t;var r=e("linky")(t,n),s="";angular.isDefined(n)&&(s=' target="'+n+'"');var o=/(^|\s)#(\w*[a-zA-Z_]+\w*)/gim;return r=t.replace(o,'$1<a href="http://www.sellyx.com/#/?h=true&q=$2"'+s+">#$2</a>")}}]),services.service("checkExpTime",["$cookies","apiCall","$q","$http","$cookies",function(e,t,n,r,e){this.refresh=function(){console.log("checking the time");var n=(new Date).getTime(),r=e.get("exp_time");if(3e5>r-n&&r-n>0){console.log("I will refersh the key");var s={method:"GET",url:"https://auth.sellyx.com/auth/refresh?key="+e.get("sellyxtoken")};t.getapi(s).then(function(t){var n=t.success.data.key,r=t.success.data.exp_time;KEY_GLO=n,e.put("sellyxtoken",n,{domain:".sellyx.com"}),e.put("exp_time",r)},function(e){})}}}]),services.factory("chatWSService",["api","$cookies","$location","Alertify",function(e,t,n,r){var s;return{start:function(e,t,r){try{s=new WebSocket(e),s.onopen=function(){s.send(t)},s.onmessage=function(e){r(e)},s.onclose=function(){console.log("WebSocket is closed"),"/chat"==n.path()}}catch(o){console.log(o),alert("Unable to connect to server")}},send:function(e){s.send(e)},close:function(){try{s.close(),console.log("close web socket")}catch(e){console.log(e)}}}}]),services.service("gritter",[function(){return{add:function(e){$.gritter.add({title:e.title?e.title:"",text:e.text?e.text:"",image:e.image?e.image:"",sticky:!1,time:"2500",class_name:e["class"]?e["class"]:""})}}}]),services.service("api",["$http","$q",function(e,t){this.call=function(n){n.method?n.method:n.method="POST";var r=t.defer();return e(n).then(function(e){return r.resolve(e.data),r.promise},function(e){return r.reject(e.data),r.promise})}}]),services.service("sharedRow",function(){var e={};return{getRow:function(){return e},setRow:function(t){e=t}}}),services.service("getInformation",[,function(){this.message_orders=function(){}}]),services.service("apiCall",["$http","$q","$cookies","Alertify","$window","$location",function(e,t,n,r,s,o){this.getapi=function(s){var a=!1;if($(".loading_notification").removeClass("hide"),s.button){var c=s.button.html();s.button.html('<i class="fa fa-spinner fa-spin"></i>'),s.button.addClass("disabled").attr("disabled",!0)}-1==s.url.search("http")&&(s.url="https://ec.sellyx.com/"+s.url),-1!==s.url.search("/a/")&&(s.headers?null:s.headers={},s.headers.key=n.get("sellyxtoken"),s.headers.entity=n.get("entity"),s.custom_currency?s.headers.currency="USD":s.headers.currency=n.get("currency"),s.headers.standard=n.get("standard"),s.headers["Content-Type"]="application/json",s.headers["Time-Zone"]=n.get("timezone")),-1!==s.url.search("/p/")&&(s.headers?null:s.headers={},s.headers.currency=n.get("currency"),s.headers.standard=n.get("standard"),s.headers["Content-Type"]="application/json",s.headers["Time-Zone"]=n.get("timezone")),s.method?s.method:s.method="POST",s.failure_message&&(a=!0);var i=t.defer();return e(s).then(function(e){return i.resolve(e.data),a||e.data.failure&&(101==parseInt(e.data.failure.code)?window.location.href="https://auth.sellyx.com/login?service=ecommerce&redirection="+o.path():r.alert(e.data.failure.msg)),i.promise},function(e){return i.reject(e.data),r.alert("There was a server error. Please wait a few minutes before trying again. If this message keeps appearing, please contact Sellyx."),i.promise})["finally"](function(){$(".loading_notification").addClass("hide"),s.button&&(s.button.html(c),s.button.removeClass("disabled").attr("disabled",!1))})}}]),services.factory("registerServ",["apiCall","$location","$cookies",function(e,t,n){return function(n){var r={method:"POST",url:"8080/register/user/new",data:n};e.getapi(r).then(function(e){return e.success?void t.path("/verif"):!1},function(e){console.log("error",e.statusText)})}}]),services.factory("loginServ",["apiCall","$state","$cookies","sessionService","Auth","$window",function(e,t,n,r,s,o){return function(o){var a={method:"POST",url:"8080/login/sellyx",headers:{id:"34857"},data:o};e.getapi(a).then(function(o){if(o.failure)return console.log(o.failure);if(o.success){$("#loginModal").modal("hide");var c=o.success;r.setToken(c),s.login(c),a={method:"POST",url:"users/a/get"},e.getapi(a).then(function(r){if(r.success){var s=r.success.data;a={method:"POST",url:"users/a/entities/summary"},e.getapi(a).then(function(e){if(e.success)var t=e.success.data;n.put("sellerInfo",t),n.put("entity",t[0].id)}),n.put("userInfo",s),n.put("currency",s.currency),n.put("standard",s.standard),t.transitionTo("manager.account")}else console.log("failing gettint user info from the server")},function(e){console.log(e)})}else console.log("something wierd")},function(e){console.log("error",e.statusText)})}}]),services.factory("Paths",[function(){return{dist:{js:{main:"dist/js/"}},img:"dist/css/img/"}}]),services.factory("status",[function(){return{change:function(e){if(e.stopImmediatePropagation(),$scope.statusRow=angular.element($(e.currentTarget)),$scope.statusRow.parents(".child-row").length>0)var t=Sellyx.row.data($scope.statusRow.parents(".child-row").parents("tr").prev("tr")),n=!0;else var t=Sellyx.row.data($scope.statusRow),n=!1;var r={url:ROOT_CONFIG_PATH+($scope.statusRow.data("path")||"")+($scope.statusRow.data("method")?$scope.statusRow.data("method"):"status"),data:"&id="+t.data.id+"&status="+$scope.statusRow.data("status")+($scope.statusRow.data("extra")?"&extra="+$scope.statusRow.data("extra"):""),button:$scope.statusRow,update:{row:t.row},success:function(e){}};$scope.statusRow.data("remove")?r.update.remove=!0:$scope.statusRow.data("merge")&&(r.update.merge=!0),r.update.child=n,console.log(r),Sellyx.ajax.standard(r)}}}]),services.factory("sessionService",["$cookies","$http","$rootScope","$cookies",function(e,t,n,e){return{generateUniqueId:function(){var e=(new Date).getUTCMilliseconds(),t=Math.random().toString(16).split(".")[1];return t+"0"+e},setToken:function(t){if(token=t,null!=t){if(null==e.get("sellyxtoken")||e.get("sellyxtoken")!=token){var n=new Date;n.setDate(n.getDate()+5)}}else e.remove("sellyxtoken")},getToken:function(){return token}}}]),services.factory("Auth",["$cookies",function(e){var t,n,r,s={},o={};return{isAuthenticated:function(){return t=null!=e.get("sellyxtoken")?!0:!1},isSeller:function(){return s=e.getObject("userInfo"),null!=JSON.parse(e.get("sellerInfo"))&&(n=!0),n},isMaster:function(){return e.getObject("entityInfo")?(s=e.getObject("userInfo"),o=e.getObject("entityInfo"),r=s.id!=o.master?!1:!0):r=!1},getUser:function(){return s},login:function(e){s=e,t=!0},logout:function(){}}}]),services.factory("locServ",["apiCall","$cookies","$q",function(e,t,n){return{getLocation:function(){function r(e){for(var t=n.defer(),r=e,s={},o=0;o<r.results.length;o++)switch(r.results[o].types[0]){case"street_number":s.street1?s.street1+=" "+r.results[o].address_components[0].long_name:s.street1=r.results[o].address_components[0].long_name;break;case"street_number":case"route":s.street1?s.street1+=" "+r.results[o].address_components[0].long_name:s.street1=r.results[o].address_components[0].long_name;break;case"premise":case"subpremise":s.street2?s.street2+=" "+r.results[o].address_components[0].long_name:s.street2=r.results[o].address_components[0].long_name;break;case"locality":s.city?null:s.city=r.results[o].address_components[0].long_name;break;case"administrative_area_level_1":s.state?null:s.state=r.results[o].address_components[0].long_name;break;case"country":s.country?null:s.country=r.results[o].address_components[0].short_name;break;case"postal_code":s.postal?null:s.postal=r.results[o].address_components[0].long_name}return t.resolve(s),t.promise}var s=function(n,s){var o={url:"http://maps.googleapis.com/maps/api/geocode/json?latlng="+n+","+s+"&sensor=true",method:"GET"};e.getapi(o).then(function(e){r(e).then(function(e){for(var r in ROOT_COUNTRIES)if(ROOT_COUNTRIES[r].country_code==e.country){var o=(ROOT_COUNTRIES[r].countryId,{city:e.city,postal:e.postal,coordinates:{lat:n,lon:s},country:{name:ROOT_COUNTRIES[r].country_name,id:ROOT_COUNTRIES[r].countryId,code:ROOT_COUNTRIES[r].country_code}});t.put("user_current_location",o)}},function(e){})},function(e){return e})},o=function(e){var t=e.coords.latitude,n=e.coords.longitude;s(t,n)},a=function(e){var t="Unknown error";switch(e.code){case 1:t="Permission denied";break;case 2:t="Position unavailable";break;case 3:t="Timeout"}},c={enableHighAccuracy:!0,timeout:3e3,maximumAge:0};navigator.geolocation.getCurrentPosition(o,a,c)}}}]),services.factory("storageService",["$rootScope",function(e){return{get:function(e){return JSON.parse(localStorage.getItem(e))},save:function(e,t){localStorage.setItem(e,JSON.stringify(t))},remove:function(e){localStorage.removeItem(e)},clearAll:function(){localStorage.clear()}}}]),services.factory("cacheService",["$http","storageService",function(e,t){return{getData:function(e){return t.get(e)},setData:function(e,n){t.save(e,n)},removeData:function(e){t.remove(e)}}}]),services.factory("stringify",[function(){var e=function(e){return null==e?"":e.toString()},t=function(n){var r={};return angular.forEach(n,function(n,s){"object"==typeof n?r[s]=t(n):r[s]=e(n)}),r};return{stringifyObjectData:function(e){return t(e)}}}]);