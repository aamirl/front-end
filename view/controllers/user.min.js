sourceAdminApp.controller("user",["$rootScope","$scope","$http","$timeout","$cookies","$location","apiCall","DTColumnBuilder","DTOptionsBuilder","$compile","gritter","Alertify","storageService","angularGridInstance",function(e,t,s,o,n,i,a,l,r,c,u,d,m,g){function h(e,s,o,n){return $(".display-comments",e).unbind("click"),$(".display-comments",e).bind("click",function(e){t.$apply(function(){t.displayComments(s,e)})}),e}$("#content").addClass("loading-display"),t.testObject={};var p=!0;t.tab={active:!0},t.userItems=[],t.reviewObject={},t.listing={message:""},t.gridWidth=190,$(window).width()<768&&(t.gridWidth=150),n.getObject("userInfo")&&(t.userInfo=n.getObject("userInfo")),t.getUserInfo=function(){var e;e=i.search().u&&""!=i.search().u?i.search().u:"no_user",$(".no-user").hide(),t.following=!1;var o={method:"POST",url:"https://ec.sellyx.com/entities/p/get",data:{id:e,type:i.search().t},headers:{currency:n.get("currency"),standard:n.get("standard"),"Time-Zone":n.get("timezone")}};s(o).then(function(e){e.data.success?(t.userDetails=e.data.success.data,t.userDetails.reviews&&(t.rating=t.userDetails.reviews.rating),t.userInfo&&t.userDetails.follows&&t.checkId(t.userInfo.id,t.userDetails.follows)&&(t.following=!0),t.loadUserItems()):($("#content").removeClass("loading-display"),$(".listing-loading").hide(),$(".show-listing").hide(),$(".no-user").show(),$(".show-footer").show())},function(e){console.log(e)})},t.viewProduct=function(e){t.productId=e,i.path("/listings").search({l:t.productId})},t.loadUserItems=function(e){t.noListings=!1,e||(t.x=0,t.y=10,t.userItems=[]),n.get("userloc")&&(t.user_location=n.getObject("userloc"),t.user_location.latitude?(t.lat=t.user_location.latitude,t.lon=t.user_location.longitude):(t.lat=t.user_location.lat,t.lon=t.user_location.lon));var s={method:"POST",url:"listings/p/get",data:{entity:t.userDetails.id,x:t.x,y:t.y},headers:{latlon:t.lat+","+t.lon},failure_message:!0};a.getapi(s).then(function(e){if(e.success){$(".show-footer").show(),$("#content").removeClass("loading-display"),$(".listing-loading").hide(),$(".no-listing").hide(),$(".show-listing").show();var s=e.success.data;t.userItems=t.userItems.concat(s),t.x+=10,e.success.counter<=t.x?t.userLoad=!1:t.userLoad=!0}else t.noListings=!0,$(".show-footer").show(),$("#content").removeClass("loading-display"),$(".listing-loading").hide(),$(".no-listing").hide(),$(".show-listing").show(),console.log(e.failure)},function(e){console.log(e)})},t.retrieveReviews=function(){var e={method:"POST",url:"reviews/p/get",data:{"for":t.userDetails.id},failure_message:!0};a.getapi(e).then(function(e){e.success?(t.reviews=e.success.data,$("#reviewTable").DataTable().clear().rows.add(t.reviews).draw()):console.log(e.failure)},function(e){console.log(e)})},t.dtOptions=r.fromSource().withPaginationType("full_numbers").withOption("rowCallback",h).withOption("createdRow",function(e,s,o){c(angular.element(e).contents())(t)}),t.dtColumns=[l.newColumn("by").withClass("no-sorting").withTitle("Reviews").renderWith(function(e,s,o,n){return t.userType=o.by.type,'<div class="col-xs-12 col-sm-5 review-style" style="padding-top: 5px"><div class="media-left"><a href="" style="padding-left: 10px; cursor: text"><img style="width: 45px" class="email-image" check-image src="https://sellyx-ecom.s3-us-west-1.amazonaws.com/'+o.by.id+'.jpg" /></a></div><div class="media-body" style="width:100%"><h5 class="media-heading" style="text-align:left"><b><a href="/#/user?u='+o.by.id+"&t="+t.userType+'">'+o.by.name+'</a></b></h5></div></div><div class="col-xs-12 col-sm-7 review-data" style="text-align: left"><uib-rating ng-init="reviewObject[\''+o.id+"'] = "+o.rating+'" style="outline: 0" class="star-rating" ng-model="reviewObject[\''+o.id+'\']" max="5" data-readonly="true"></uib-rating><span style="position:relative; bottom:5px" class="review-date">'+o.setup.added.converted.readable+'</span><p style="margin-top: 10px">'+o.message+'</p></div><div class="col-xs-12" style="text-align: left; margin-top: 20px"><div class="col-xs-6 col-sm-5"><a style="position:relative; top: 5px" class="display-comments clickable">'+o.comments.length+' comments</a></div><div class="col-xs-6 col-sm-7"><button style="font-size: 15px; float: right" class="btn-primary" ng-click="commentReview(\''+o.id+'\',$event)">Comment</button></div><div class="col-xs-12 comment'+o.id+'" style="display:none" ng-click="$event.stopImmediatePropagation()"><textarea style="width: 100%; height: 150px; margin-top: 15px; margin-bottom: 15px"></textarea><button style="float: right" type="button" class="btn btn-primary" ng-click="submitComment(\''+o.id+"',$event)\">Submit Comment</button></div>"})],t.commentReview=function(e,t){t.stopImmediatePropagation(),$(".comment"+e).slideToggle()},t.displayComments=function(e,s){var o=$("#reviewTable").DataTable(),n=angular.element($(s.currentTarget)).closest("tr"),i=o.row(n);if(t.childrow=n,t.comments=e.comments,0!=t.comments.length){var a="";a+='<h3 style="text-align: left">'+t.comments.length+" COMMENTS</h3>",angular.forEach(t.comments,function(e,t){a+='<div style="text-align:left; border-top:1px solid #DDD; padding: 10px"><div class="media-left"><a href="" style="padding-left: 10px; cursor: text"><img style="width: 45px" class="email-image" check-image src="https://sellyx-ecom.s3-us-west-1.amazonaws.com/'+e.entity.id+'.jpg" /></a></div><div class="media-body"><h5 class="media-heading"><a href="/#/user?u='+e.entity.id+"&t="+e.entity.type+'"><b>'+e.entity.name+'</b></a></h5><h5 style="margin-top: 0">'+e.setup.added.converted.readable+'</h5><div class="message-body"><pre style="padding-top: 15px !important; padding-right: 70px !important;padding-left: 0; background:none; border: none; font-family: \'Lato\', Sans-serif">'+e.comment+"</pre></div></div></div></div>"}),i.child.isShown()?i.child.hide():(i.child(a).show(),$(n).next().css("background","whitesmoke"),c(angular.element($(".email-image, .delete-comment")))(t))}},t.submitComment=function(e,s){if(!t.loginCheck()){if(""==$(".comment"+e+" textarea").val())return void u.add({text:"You must submit a comment.",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});var n={method:"POST",url:"reviews/a/comment/add",data:{id:e,comment:$(".comment"+e+" textarea").val()},button:angular.element($(s.currentTarget))};a.getapi(n).then(function(s){s.success?($(".comment"+e).slideToggle(),$(".comment"+e+" textarea").val(""),o(function(){t.retrieveReviews()},300),u.add({text:"Your comment was submitted.",title:"Success",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Success.png"})):console.log(s.failure)},function(e){console.log(e)})}},t.loginCheck=function(){return n.get("sellyxtoken")&&n.getObject("userInfo")?void 0:($("#login_modal").modal("show"),t.url=encodeURIComponent(i.url()),!0)},t.deleteComment=function(e){d.confirm("Are you sure you would like to delete this comment?").then(function(){var s={method:"POST",url:"reviews/a/comment/delete",data:{id:e},button:angular.element($(event.currentTarget))};a.getapi(s).then(function(s){s.success?($(".comment"+e).slideToggle(),$(".comment"+e+" textarea").val(""),o(function(){t.retrieveReviews()},250)):console.log(s.failure)},function(e){console.log(e)})})},t.upvote=function(e,s){if(!t.loginCheck()){var o={method:"POST",url:"reviews/a/upvote",data:{id:e},button:angular.element($(s.currentTarget))};$(o.button).find("span").html(parseInt($(o.button).find("span").html())+1)}},t.downvote=function(e,s){if(!t.loginCheck()){var o={method:"POST",url:"reviews/a/downvote",data:{id:e},button:angular.element($(s.currentTarget))};$(o.button).find("span").html(parseInt($(o.button).find("span").html())+1)}},t.openMessages=function(){$(".message").val(""),t.loginCheck()||(t.convertMessage=function(){$("#output").text(t.listing.message)},t.thread=!1,t.message_loaded=!0,$("#message_modal").modal("show"),$(".message").on("keyup",function(){$("#output").text($(".message").val())}))},t.sendMessage=function(e){if(""==$(".message").val())return void u.add({text:"You must submit a message",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});var s={method:"POST",url:"messages/a/upsert",data:{recipients:t.userDetails.id,message:$("#output").text(),subject:$(".subject").val()},button:angular.element($(e.currentTarget))};a.getapi(s).then(function(e){e.success?($("#message_modal").modal("hide"),u.add({text:"Your message was sent",title:"Success",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Success.png"})):console.log(e.failure)},function(e){console.log(e)})},t.downvote=function(e,s){if(!t.loginCheck()){var o={method:"POST",url:"reviews/a/downvote",data:{id:e},button:angular.element($(s.currentTarget))};a.getapi(o).then(function(e){e.success||console.log(e.failure)},function(e){console.log(e)})}},t.followEntity=function(e){if(!t.loginCheck()){n.getObject("userInfo").id!=i.search().u&&(t.following?t.following=!1:t.following=!0);var s={method:"POST",url:"entities/a/follow",data:{type:i.search().t?i.search().t:"t1",id:i.search().u,add:t.following},button:angular.element($(e.currentTarget))};a.getapi(s).then(function(e){e.success||console.log(e.failure)},function(e){console.log(e)})}},t.checkId=function(e,t){var s=t.some(function(t){return t.id===e});return s?!0:!1},t.scrollTop=function(e,t){i.search({u:e,t:t}),window.scrollTo(0,0)},t.$watch(function(){return i.search().u},function(e){if(p)o(function(){p=!1});else{if(void 0==e)return;t.tab={active:!0},$("#reviewTable").DataTable().clear().rows.add([]).draw(),t.getUserInfo()}}),t.getUserInfo()}]);