sourceAdminApp.controller("listings",["$rootScope","$scope","$http","$timeout","$cookies","$location","apiCall","Alertify","$window","gritter","storageService",function(e,t,o,s,a,r,i,n,l,c,d){function u(){var e={zoom:7,maxZoom:13,scrollwheel:!1,center:new google.maps.LatLng(0,0)};map=new google.maps.Map(document.getElementById("map"),e);var t=new google.maps.LatLngBounds;f(map,t),map.fitBounds(t)}function f(e,o){var s={coords:[1,1,1,20,18,20,18,1],type:"circle"},a=new google.maps.Marker({position:{lat:t.productDetails.location.coordinates.lat,lng:t.productDetails.location.coordinates.lon},map:e,animation:google.maps.Animation.DROP,shape:s});o.extend(a.position)}function p(e){for(;/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");return e}$("#content").addClass("loading-display");var g=!0;t.gridWidth=190,$(window).width()<768&&(t.gridWidth=150),t.card={name:"",number:"",exp_month:"",exp_year:"",cvc:""},t.offer={price:"",qty:"1"},t.interest={price:"",contact:"1",message:"",custome:""},t.listing={message:""},t.cardId="",t.userItems=[],t.showRating=!1,t.sellyxPayOption=!1,t.purchasing=!1,t.addCard=!1,a.getObject("userInfo")&&(t.userInfo=a.getObject("userInfo")),t.$watch(function(){return r.search().l},function(e){if(g)s(function(){g=!1});else{if(void 0==e)return;if(t.watchQuery)return void(t.watchQuery=!1);t.viewProduct(e,"watch")}}),t.load=function(e){var s;s=r.search().l&&""!=r.search().l?r.search().l:"error",$(".no-listing").hide(),t.following=!1,t.favorite=!1;var i={method:"POST",url:"https://ec.sellyx.com/listings/p/get",data:{id:s},headers:{currency:a.get("currency"),standard:a.get("standard"),"Time-Zone":a.get("timezone")}};o(i).then(function(o){o.data.success?(t.productDetails=o.data.success.data,t.purchaseAvatar="https://sellyx-ecom.s3-us-west-1.amazonaws.com/s_"+t.productDetails.images[0],t.displayImage="https://sellyx-ecom.s3-us-west-1.amazonaws.com/l_"+t.productDetails.images[0],t.productImages=[],t.tweetLink=encodeURIComponent("http://www.sellyx.com/#/listings?l="+t.productDetails.id),angular.forEach(t.productDetails.images,function(e,o){var s="https://sellyx-ecom.s3-us-west-1.amazonaws.com/l_"+e;t.productImages.push({thumb:s,img:s})}),t.productDetails.quantity&&(t.productDetails.quantity>t.productDetails.quantity_mpo?t.number=t.productDetails.quantity_mpo-1:t.number=t.productDetails.quantity-1),t.priceConversion=parseFloat(t.productDetails.price.converted.substr(t.productDetails.price.converted.indexOf(" ")+1).replace(/,/g,"")).toFixed(2),t.priceConversionCommas=p(t.priceConversion),t.originalPriceConversion=p(t.productDetails.price.data.toFixed(2)),t.userInfo&&t.productDetails.followers&&t.checkId(t.userInfo.id,t.productDetails.followers)&&(t.following=!0),t.userInfo&&t.productDetails.favorites&&t.checkId(t.userInfo.id,t.productDetails.favorites)&&(t.favorite=!0),e?($("#content").removeClass("loading-display"),$(".listing-loading").hide(),$(".no-listing").hide(),$(".show-listing").show(),u()):(t.loadUserItems(),t.getReviews())):($(".show-footer").show(),$("#content").removeClass("loading-display"),$(".listing-loading").hide(),$(".show-listing").hide(),$(".no-listing").show())},function(e){console.log(e),$(".show-footer").show(),$("#content").removeClass("loading-display"),$(".listing-loading").hide(),$(".show-listing").hide(),$(".no-listing").show()})},t.loadUserItems=function(e,o){if(o){var s=angular.element($(o.currentTarget)),r=s.html();s.html('<i class="fa fa-spinner fa-spin"></i>'),s.addClass("disabled").attr("disabled",!0)}e||(t.x=0,t.y=10),a.get("userloc")&&(t.user_location=a.getObject("userloc"),t.user_location.latitude?(t.lat=t.user_location.latitude,t.lon=t.user_location.longitude):(t.lat=t.user_location.lat,t.lon=t.user_location.lon));var n={method:"POST",url:"listings/p/get",data:{entity:t.productDetails.entity.id,x:t.x,y:t.y},headers:{latlon:t.lat+","+t.lon}};i.getapi(n).then(function(e){if(e.success){$("#content").removeClass("loading-display"),$(".listing-loading").hide(),$(".no-listing").hide(),$(".show-listing").show(),u();var o=e.success.data;t.userItems=t.userItems.concat(o)}else console.log(e.failure);t.x+=10,e.success.counter<=t.x?t.userLoad=!1:t.userLoad=!0,$(".show-footer").show()},function(e){console.log(e)})["finally"](function(){s&&(s.html(r),s.removeClass("disabled").attr("disabled",!1))})},t.getReviews=function(){var e={method:"POST",url:"entities/p/get",data:{id:t.productDetails.entity.id},failure_message:!0};i.getapi(e).then(function(e){e.success?e.success.data.reviews&&(t.rating=e.success.data.reviews.rating,t.showRating=!0):console.log(e.failure)},function(e){console.log(e)})},t.viewProduct=function(e,o){t.watchQuery=!0,r.search({l:e}),0==t.userItems.length?t.load():t.load("dontLoad"),window.scrollTo(0,0),o&&(t.watchQuery=!1)},t.openMessages=function(){if($(".message").val(""),!t.loginCheck()){t.thread=!1,t.message_loaded=!1;var e={method:"POST",url:"messages/a/get/thread/listing",data:{listing:t.productDetails.id},failure_message:!0};i.getapi(e).then(function(e){e.success&&(t.thread_id=e.success.data.id,t.thread=!0)},function(e){console.log(e)})["finally"](function(){t.message_loaded=!0}),$("#message_modal").modal("show")}},t.convertMessage=function(){$("#output").text(t.listing.message)},t.openInterests=function(){t.interest={price:"",contact:"1",message:"",custome:""},t.loginCheck()||$("#interest_modal").modal("show")},t.openKey=function(){if(t.purchased=!1,t.addCard=!1,t.cardsLoaded=!1,t.cardId="",t.offer={price:"",qty:"1"},t.productDetails.p_type&&(t.offer.price=t.priceConversion),!t.loginCheck()){t.card={},t.cardError="",t.sellyxError="";var e={method:"POST",url:"payments/sources/a/all",data:{id:t.userInfo.id},failure_message:!0};i.getapi(e).then(function(e){e.success?t.savedCards=e.success.data:(t.addCard=!0,console.log(e.failure))},function(e){console.log(e)})["finally"](function(){t.cardsLoaded=!0}),$("#key_modal").on("shown.bs.modal",function(){t.productDetails.p_type&&(1==t.productDetails.p_type.data?$(".offer-price").prop("disabled",!0):$(".offer-price").prop("disabled",!1))}),$("#key_modal").modal("show")}},t.viewUser=function(e,t){r.path("/user").search({u:e,t:t})},t.getNumber=function(e){return new Array(e)},t.loginCheck=function(){return a.get("sellyxtoken")&&a.getObject("userInfo")?void 0:($("#login_modal").modal("show"),t.url=encodeURIComponent(r.url()),!0)},t.submitForm=function(){if(parseFloat(t.offer.price)<.5)return void c.add({text:"The lowest offer you can make for any item is $0.50",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});t.cardError="";var o=$("#payment-form"),s=o.find("button").html();return t.purchasing=!0,o.find("button").html('<i class="fa fa-spinner fa-pulse"></i>').prop("disabled",!0),Stripe.card.createToken(o,function(a,r){if(console.log(r),r.error)o.find("button").html(s).prop("disabled",!1),t.purchasing=!1,t.$apply(function(){t.cardError="*"+r.error.message});else{var n=t.offer.price?t.offer.price:t.priceConversion,l=t.offer.qty&&t.offer.qty>1?t.offer.qty:"1";t.amount=e.currencySymbol+t.fixedNumber(n*l*1.03,2);var c={id:t.productDetails.id,amount:n*l*1.03,quantity:l,transactions:[{amount:t.fixedNumber(n*l*1.03,2),type:"stripe",token:r.id}]},d={method:"POST",url:"listings/a/order/authorize",data:c,failure_message:!0};i.getapi(d).then(function(e){e.success?(console.log(e.success.id),t.offer.price<t.priceConversion?t.bestOffer=!0:t.bestOffer=!1,t.purchased=!0):(console.log(e.failure),t.cardError="*"+e.failure.msg),t.purchasing=!1,o.find("button").html(s).prop("disabled",!1)},function(e){t.purchasing=!1,o.find("button").html(s).prop("disabled",!1),console.log(e)})}}),!1},t.savedCardPurchase=function(){if(parseFloat(t.offer.price)<.5)return void c.add({text:"The lowest offer you can make for any item is $0.50",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});if(t.purchasing=!0,""==t.cardId)return c.add({text:"You must select a saved card.",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"}),void(t.purchasing=!1);var o=t.offer.price?t.offer.price:t.priceConversion,s=t.offer.qty&&t.offer.qty>1?t.offer.qty:"1";t.amount=e.currencySymbol+t.fixedNumber(o*s*1.03,2);var a={id:t.productDetails.id,amount:o*s*1.03,quantity:s,transactions:[{amount:t.fixedNumber(o*s*1.03,2),type:"stripe",card:t.cardId}]},r={method:"POST",url:"listings/a/order/authorize",data:a,failure_message:!0};i.getapi(r).then(function(e){e.success?(console.log(e.success.id),t.offer.price<t.priceConversion?t.bestOffer=!0:t.bestOffer=!1,t.purchased=!0):(console.log(e.failure),t.cardError="*"+e.failure.msg),t.purchasing=!1},function(e){t.purchasing=!1})},t.sellyxPay=function(e){if(parseFloat(t.offer.price)<.5)return void c.add({text:"The lowest offer you can make for any item is $0.50",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});t.purchasing=!0,t.sellyxError="";var o=t.offer.price?t.offer.price:t.productDetails.price.data,s=t.offer.qty&&t.offer.qty>1?t.offer.qty:"1";t.amount="$"+t.fixedNumber(o*s,2);var a={id:t.productDetails.id,price:o*s,quantity:s,transactions:[{amount:t.fixedNumber(o*s,2),type:"sellyx"}]},r={method:"POST",url:"listings/a/order/authorize",data:a,button:angular.element($(e.currentTarget)),failure_message:!0,custom_currency:!0};i.getapi(r).then(function(e){e.success?(console.log(e.success.id),t.offer.price<t.priceConversion?t.bestOffer=!0:t.bestOffer=!1,t.purchasing=!1,t.purchased=!0):(console.log(e.failure),t.purchasing=!1,t.sellyxError="*"+e.failure.msg)},function(e){console.log(e),t.purchasing=!1})},t.sendMessage=function(e){if(""==$(".message").val())return void c.add({text:"You must submit a message",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});var o={method:"POST",url:"messages/a/upsert",data:{message:$("#output").text(),subject:"Listing: "+t.productDetails.title,listing:t.productDetails.id},button:angular.element($(e.currentTarget))};i.getapi(o).then(function(e){e.success?($("#message_modal").modal("hide"),c.add({text:"Your message was sent",title:"Success",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Success.png"})):console.log(e.failure)},function(e){console.log(e)})},t.watchListing=function(e,o){if(!t.loginCheck()){t.following?t.following=!1:t.following=!0;var s={method:"POST",url:"listings/a/follow",data:{id:e,add:t.following}};i.getapi(s).then(function(e){e.success?console.log(e.success):console.log(e.failure)},function(e){console.log(e)})}},t.flagListing=function(e,o){t.loginCheck()||n.confirm("Are you sure you would like to flag this listing?").then(function(){if(t.productDetails.flags)return void(t.checkId(t.userInfo.id,t.productDetails.flags.entities)&&c.add({text:"You have already flagged this listing.",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"}));var o={method:"POST",url:"listings/a/flag",data:{id:e}};i.getapi(o).then(function(e){e.success?c.add({text:"This listing has been flagged.",title:"Success",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Success.png"}):console.log(e.failure)},function(e){console.log(e)})})},t.openShareModal=function(){$("#share_modal").modal("show")},t.favoriteListing=function(e,o){if(!t.loginCheck()){t.favorite?t.favorite=!1:t.favorite=!0;var s={method:"POST",url:"listings/a/favorite",data:{id:e,add:t.favorite}};i.getapi(s).then(function(e){e.success?console.log(e.success):console.log(e.failure)},function(e){console.log(e)})}},t.checkId=function(e,t){var o=t.some(function(t){return t.id===e});return o?!0:!1},t.switchPay=function(){t.productDetails&&(1==t.productDetails.p_type.data&&s(function(){$(".offer-price").prop("disabled",!0)}),t.productDetails&&(t.sellyxPayOption?(t.sellyxPayOption=!1,t.offer.price=t.priceConversion):(t.sellyxPayOption=!0,t.offer.price=t.productDetails.price.data.toFixed(2))))},t.newCard=function(){t.addCard?t.addCard=!1:t.addCard=!0},t.selectCard=function(e){var o=angular.element($(e.currentTarget));t.cardId=o.data("card"),o.hasClass("selected-card")?(o.removeClass("selected-card"),t.cardId=""):($(".selected-card").removeClass("selected-card"),o.addClass("selected-card"))},t.fixedNumber=function(e,t){return(+(Math.round(+(e+"e"+t))+"e"+-t)).toFixed(t)},t.priceError=function(e){if(t.offer.price.length<2)return void("."==t.offer.price&&(t.offer.price="0."));var o=t.offer.price.split(".",2);o[1].length>2&&(t.offer.price=t.offer.price.substr(0,t.offer.price.length-1)),isNaN(parseFloat(t.offer.price*t.offer.qty))&&(t.offer.price="",c.add({text:"Please enter a valid number.",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"})),t.offer.price.length<3||e.keyCode>=48&&e.keyCode<=57&&parseFloat(t.offer.price)<.5&&(t.offer.price="",c.add({text:"The lowest offer you can make for any item is $0.50",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"}))},t.load()}]);