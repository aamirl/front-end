sourceAdminApp.controller("header",["$rootScope","$scope","$http","$timeout","$cookies","$location","$window","$state","sessionService","apiCall","Auth","Alertify","storageService",function(e,r,o,t,s,n,a,c,i,l,u,d,h){function m(e){return 10>e?"0"+e.toString():e.toString()}if(s.get("mobile")&&$("#header, #footer").css("display","none"),r.x=0,r.y=40,e.loadMore=!1,r.filter={},r.search={query:""},r.model={addresses:""},e.setting.layout.pageWithoutSidebar=!0,e.items=[],r.currencies=ROOT_CURRENCIES,r.initializing=!0,r.loadListing=!0,r.googleMaps=!0,e.infiniteScroll=!0,r.searchDropdown="All",r.categories={1:"Books",2:"Movies/Music",3:"Electronics",4:"Clothing",5:"Jewelry",6:"Shoes / Accessories",7:"Games/Toys",8:"Home / Garden",9:"Health",10:"Beauty",11:"Food / Beverages",12:"Sports / Outdoors",13:"Automotive",14:"Industrial",15:"Pets/Animals",16:"Office / School",17:"Travel",18:"Tickets",19:"Other"},r.deleteParams=function(){n.search("key",null),n.search("service",null),n.search("redirection",null)},n.search().redirection&&n.url(n.search().redirection),n.search().key&&n.search({key:null}),s.get("timezone")||(r.timezone=jstz.determine(),s.put("timezone",r.timezone.name())),s.get("sellyxtoken")){var y={method:"GET",url:"https://auth.sellyx.com/auth/validate?key="+s.get("sellyxtoken"),failure_message:!0};l.getapi(y).then(function(o){if(o.success){var t=o.success.data.user;if(s.getObject("userInfo")&&s.getObject("userInfo").id==t.id)userInfo=s.getObject("userInfo"),r.userInfo=userInfo,r.chosenCurrency=s.get("currency")?s.get("currency"):"USD",r.chosenStandard="US System",e.currencySymbol=r.currencies[r.chosenCurrency].symbol,r.loggedIn=!0,r.avatar="https://sellyx-ecom.s3-us-west-1.amazonaws.com/"+r.userInfo.id+".jpg",r.userName=r.userInfo.name.display,s.get("sellerInfo")?(n.path(n.search().redirection),r.deleteParams()):(req={method:"POST",url:"users/a/entities/summary"},l.getapi(req).then(function(e){if(e.success){var o=e.success.data;n.path(n.search().redirection),r.deleteParams()}s.putObject("sellerInfo",o),s.put("entity",o[0].id)}));else{var a=n.url();n.path("/redirect").search({redirection:a})}}else if(o.failure)return s.remove("userInfo"),s.remove("sellyxtoken"),s.remove("sellerInfo"),s.remove("exp_time"),s.remove("entity"),s.remove("entityInfo"),s.get("currency")?(r.chosenCurrency=s.get("currency"),r.chosenStandard="US"==s.get("standard")?"US System":"Metric System",e.currencySymbol=r.currencies[r.chosenCurrency].symbol):(r.chosenCurrency="USD",r.chosenStandard="US System",e.currencySymbol=r.currencies[r.chosenCurrency].symbol,s.put("standard","US"),s.put("currency",r.chosenCurrency)),r.loggedIn=!1,void $(".login-buttons").show()},function(e){console.log(e)})}else s.get("currency")?(r.chosenCurrency=s.get("currency"),r.chosenStandard="US"==s.get("standard")?"US System":"Metric System",e.currencySymbol=r.currencies[r.chosenCurrency].symbol):(r.chosenCurrency="USD",r.chosenStandard="US System",e.currencySymbol=r.currencies[r.chosenCurrency].symbol,s.put("standard","US"),s.put("currency",r.chosenCurrency)),r.loggedIn=!1,t(function(){$(".login-buttons").show()});if(n.search().q&&(r.search={query:n.search().q}),n.search().type)switch(n.search().type){case"1":r.searchDropdown="For Sale";break;case"2":r.searchDropdown="For Borrow";break;case"3":r.searchDropdown="Service";break;case"4,5":r.searchDropdown="Housing";break;case"6,7,8":r.searchDropdown="Employment/Careers";break;default:r.searchDropdown="All Types"}n.search().categories&&(console.log(n.search().categories),r.searchDropdown=r.categories[parseInt(n.search().categories)]),e.load=function(t,a){e.infiniteScroll=!0,e.clearSearch=!1,e.listings_loaded=!1,$(".no-results").hide(),$(".searchbar").hide(),$(".mobile-searchbar").hide();var c={};if(a){var i=angular.element($(a.currentTarget)),l=i.html();i.html('<i class="fa fa-spinner fa-spin"></i>'),i.addClass("disabled").attr("disabled",!0)}t&&"load"!=t&&(r.x=0,r.y=40,e.items=[],""!==r.search.query&&void 0!==r.search.query&&(e.clearSearch=!0,c.q=r.search.query),$.isEmptyObject(r.filter)||(angular.forEach(r.filter,function(e,o){return"type"==o||"categories"==o||$("#"+o).is(":visible")?void("minprice"==o||"maxprice"==o?c.price=""+(r.filter.minprice?r.filter.minprice:0)+","+(r.filter.maxprice?r.filter.maxprice:1e8):e.join?c[o]=e.join(","):c[o]=e):(delete r.filter[o],!0)}),e.clearSearch=!0),"previous"!=t&&(r.watchQuery=!0,n.search(c))),r.model.addresses?(r.lat=r.model.addresses.geometry.location.lat,r.lon=r.model.addresses.geometry.location.lng,s.putObject("loc",r.model.addresses),e.user_locate=r.model.addresses.formatted_address):s.get("loc")?(r.userLocation=s.getObject("loc"),r.lat=r.userLocation.geometry.location.lat,r.lon=r.userLocation.geometry.location.lng):r.user_location.latitude?(r.lat=r.user_location.latitude,r.lon=r.user_location.longitude):(r.lat=r.user_location.lat,r.lon=r.user_location.lon),$.isEmptyObject(n.search())||(e.clearSearch=!0,c=n.search()),"go"==t&&"/"!=n.path()&&(e.dontLoad=!0,n.path("/")),c.x=r.x,c.y=r.y,c.distance?"":c.distance=50;var u={method:"POST",url:"https://ec.sellyx.com/listings/p/get",data:c,headers:{latlon:r.lat+","+r.lon,currency:s.get("currency"),standard:s.get("standard"),"Time-Zone":s.get("timezone")}};o(u).then(function(o){if(o.data.success){var t=o.data.success.data;e.items=e.items.concat(t),$("#filter_modal").modal("hide"),$("body").removeClass("modal-open"),$(".modal-backdrop").remove(),$(".mobile-searchbar").hide(),r.x+=40,o.data.success.counter<=r.x?e.loadMore=!1:(e.loadMore=!0,40==r.x?e.infiniteScroll=!0:e.infiniteScroll=!1)}else e.loadMore=!1,$("#filter_modal").modal("hide"),$(".mobile-bar").is(":visible")?$(".mobile-searchbar").show():$(".searchbar").show(),$(".no-results").show()},function(e){console.log(e)})["finally"](function(){i&&(i.html(l),i.removeClass("disabled").attr("disabled",!1)),e.listings_loaded=!0,$(".show-footer").show()})},r.retrieveLocation=function(){var t={method:"GET",url:"https://accounts.sellyx.com/get/location?key=TlqTXUwUSj71d6WfOcNU0Fua2veObAeXzAnOfktM"};o(t).then(function(o){s.get("userloc")&&s.get("loc")&&(console.log(s.getObject("userloc")),console.log(JSON.stringify(o.data)),JSON.stringify(s.getObject("userloc"))!=JSON.stringify(o.data)&&s.remove("loc")),s.putObject("userloc",o.data),r.user_location=o.data,-1!=r.user_location.city.indexOf("(")&&(r.user_location.city=r.user_location.city.substring(0,r.user_location.city.indexOf("("))),e.user_locate=r.user_location.city+", "+r.user_location.state,s.get("loc")&&(r.user_location=s.getObject("loc"),e.user_locate=r.user_location.formatted_address),"/"==n.path()&&(e.dontLoad?e.dontLoad=!1:r.load())},function(o){r.user_location={lat:34.024212,lon:-118.496475,city:"Santa Monica",state:"CA"},e.user_locate=r.user_location.city+", "+r.user_location.state,s.putObject("userloc",r.user_location),r.load()})},e.filtering=function(){r.removeListingType=!1,(r.filter.categories||n.search().categories)&&(r.removeListingType=!0),$.isEmptyObject(n.search())||angular.forEach(n.search(),function(e,o){r.filter[o]=e}),console.log(r.filter),$(window).width()>767&&$(".empty-option").remove(),$("#filter_modal").modal("show")},r.refreshAddresses=function(e){if(r.googleMaps)return void(r.googleMaps=!1);var t={address:e,sensor:!1};return o.get("http://maps.googleapis.com/maps/api/geocode/json",{params:t}).then(function(e){return r.addresses=e.data.results})},r.changeStandard=function(e){s.put("standard",e),r.chosenStandard="US"==e?"US System":"Metric System",a.location.reload()},r.changeCurrency=function(o){s.put("currency",o),r.chosenCurrency=o,e.currencySymbol=r.currencies[r.chosenCurrency].symbol,a.location.reload()},r.changeListingType=function(e){e.length&&(2==e.length&&0==$.inArray("4",e)&&1==$.inArray("5",e)?r.housing=!0:r.housing=!1,2==e.length&&0==$.inArray("6",e)&&1==$.inArray("7",e)?r.employment=!0:r.employment=!1)},r.randomNum=function(e){var r=e.length,o=Math.floor(Math.random()*r);return console.log(o),"https://sellyx-ecom.s3-us-west-1.amazonaws.com/l_"+e[o]+"?AWSAccessKeyId=AKIAIZYV5W77V235JRWQ"},r.goHome=function(){if("/"!=n.path())r.loadListing=!1,n.path("/").search("");else{if($.isEmptyObject(n.search()))return;r.search.query="",r.filter={},n.path("/").search(""),t(function(){a.location.reload()},100)}},r.resetFilters=function(){r.filter={}},r.showSearch=function(){$(".searchbar").is(":visible")?$(".searchbar").slideToggle(200):$(".searchbar").slideToggle(200)},r.showMobileSearch=function(){$(".mobile-searchbar").is(":visible")?$(".mobile-searchbar").slideToggle(200):$(".mobile-searchbar").slideToggle(200)},r.loginRedirect=function(){a.location.href="https://auth.sellyx.com/login?service=www&redirection="+encodeURIComponent(n.url())},r.registerRedirect=function(){a.location.href="https://auth.sellyx.com/register?service=www&redirection="+encodeURIComponent(n.url())},r.$watch(function(){return n.search()},function(o){if("/"==n.path()){if(r.initializing)return void t(function(){r.initializing=!1});if(n.search().h)return void n.search("h",null);if(!r.loadListing)return void(r.loadListing=!0);if("/"==n.path()){if(r.watchQuery)return void(r.watchQuery=!1);n.search().q?r.search={query:n.search().q}:r.search={query:""},e.load("previous")}}}),r.openCurrency=function(e){e?r.showCurrency=!0:r.showCurrency=!1,$("#currency_modal").modal("show")},r.searchFilter=function(e,o,t){r.searchDropdown=angular.element($(t.currentTarget)).children("a").html(),r.filter={},""!=e&&("categories"!=e&&4==o?r.filter[e]=o+",5":"categories"!=e&&6==o?r.filter[e]=o+",7,8":"categories"==e?(r.filter[e]=m(o),console.log(r.filter)):r.filter[e]=o)},e.clearSearchFilter=function(){n.search({}),r.filter={},r.searchDropdown="All Types"},r.logout=function(){s.remove("userInfo"),s.remove("sellerInfo"),s.remove("exp_time"),s.remove("entity"),s.remove("entityInfo"),s.remove("standard"),s.remove("currency"),s.remove("messages"),s.remove("orders"),r.loggedIn=!1,t(function(){$(".login-buttons").show()}),a.location.href="https://auth.sellyx.com/logout?service=www&redirection="+encodeURIComponent(n.url())},r.retrieveLocation()}]);