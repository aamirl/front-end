sourceAdminApp.controller("chatCtrl",["$rootScope","$scope","$http","$timeout","$cookies","$location","api","chatWSService","$location","apiCall","gritter","storageService","Alertify",function(e,t,o,s,r,a,i,n,a,c,l,u,d){function f(e){for(;/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");return e}t.msgs=[],t.offer={price:"",qty:"1"},t.interest={price:"",contact:"1",message:"",custome:""},t.listing={message:""},t.cardId="",t.showRating=!1,t.sellyxPayOption=!1,t.purchasing=!1,t.addCard=!1,r.getObject("userInfo")&&(t.userInfo=r.getObject("userInfo")),t.username=t.userInfo?t.userInfo.name.display:"Guest"+1e6*Math.random(),a.search().key&&r.put("room_key",a.search().key);var p={method:"GET",url:"https://chatting.sellyx.com/room/enter?room="+r.get("room_key"),headers:{Authorization:r.get("sellyxtoken")}};i.call(p).then(function(e){if(e.success){t.data=e.success.data,$(".no-listing").hide();var i={method:"POST",url:"https://ec.sellyx.com/listings/p/get",data:{id:t.data.product_id},headers:{currency:r.get("currency"),standard:r.get("standard"),"Time-Zone":r.get("timezone")}};o(i).then(function(e){if(e.data.success){t.productDetails=e.data.success.data,t.purchaseAvatar="https://sellyx-ecom.s3-us-west-1.amazonaws.com/s_"+t.productDetails.images[0],t.productDetails.quantity&&(t.productDetails.quantity>t.productDetails.quantity_mpo?t.number=t.productDetails.quantity_mpo-1:t.number=t.productDetails.quantity-1),t.priceConversion=parseFloat(t.productDetails.price.converted.substr(t.productDetails.price.converted.indexOf(" ")+1).replace(/,/g,"")).toFixed(2),t.priceConversionCommas=f(t.priceConversion),t.originalPriceConversion=f(t.productDetails.price.data.toFixed(2)),t.tweetLink=encodeURIComponent("http://www.sellyx.com/#/listings?l="+t.productDetails.id),t.userInfo&&t.productDetails.followers&&t.checkId(t.userInfo.id,t.productDetails.followers)&&(t.following=!0),t.userInfo&&t.productDetails.favorites&&t.checkId(t.userInfo.id,t.productDetails.favorites)&&(t.favorite=!0);var o={method:"POST",url:"entities/p/get",data:{id:t.productDetails.entity.id},failure_message:!0};c.getapi(o).then(function(e){e.success?e.success.data.reviews&&(t.rating=e.success.data.reviews.rating,t.showRating=!0):console.log(e.failure)},function(e){console.log(e)})}else $("#content").removeClass("loading-display"),$(".listing-loading").hide(),$(".show-listing").hide(),$(".no-listing").show()},function(e){console.log(e)});var l=t.data.room_port-2e3,u="ws://"+t.data.room_ip+":"+l;handShake="key="+t.data.room_dkey+"&name="+t.username+"&usertype=1",n.start(u,handShake,function(e){if("OK"!=e.data){var o=e.data,r=o.indexOf("#"),a=o.indexOf("#",r+1),i=o.charAt(r-1),n="",c="",l="";if("$"==i&&(c=o.charAt(r+1),l=o.substr(a+1),"1"==c&&(n="joined the room"),"2"==c&&(n="left the room"),"5"==c&&(n="The seller exited the room. Feel free to stay in the chat room to view the chat history but you will no longer be able to send messages.")),"1"==i&&(l=o.substring(r+1,a),n=o.substr(a+1)),l==t.username)return;t.msgs.push({user:l,msg:n}),t.$apply(),s(function(){$("#chatmessages").prop({scrollTop:$("#chatmessages").prop("scrollHeight")})},250)}else if(console.log("hand shake success"),Hls.isSupported()){var u=document.getElementById("video"),d=new Hls;d.loadSource("http://chatting.sellyx.com/hls/"+t.data.room_dkey+".m3u8"),d.attachMedia(u),d.on(Hls.Events.MANIFEST_PARSED,function(){u.play()})}})}else a.path("/rooms"),r.remove("room_key")},function(e){a.path("/rooms")}),t.sendMsg=function(e){e&&(t.msgs.push({user:t.username,msg:e}),s(function(){$("#chatmessages").prop({scrollTop:$("#chatmessages").prop("scrollHeight")})},250),n.send(e),t.newMsg="")},t.openMessages=function(){if($(".message").val(""),!t.loginCheck()){t.thread=!1,t.message_loaded=!1;var e={method:"POST",url:"messages/a/get/thread/listing",data:{listing:t.productDetails.id},failure_message:!0};c.getapi(e).then(function(e){e.success&&(t.thread_id=e.success.data.id,t.thread=!0)},function(e){console.log(e)})["finally"](function(){t.message_loaded=!0}),$("#message_modal").modal("show")}},t.convertMessage=function(){$("#output").text(t.listing.message)},t.openInterests=function(){t.interest={price:"",contact:"1",message:"",custome:""},t.loginCheck()||$("#interest_modal").modal("show")},t.openKey=function(){if(t.purchased=!1,t.addCard=!1,t.cardsLoaded=!1,t.cardId="",t.offer={price:"",qty:"1"},t.productDetails.p_type&&(t.offer.price=t.priceConversion),!t.loginCheck()){t.card={},t.cardError="",t.sellyxError="";var e={method:"POST",url:"payments/sources/a/all",data:{id:t.userInfo.id},failure_message:!0};c.getapi(e).then(function(e){e.success?t.savedCards=e.success.data:(t.addCard=!0,console.log(e.failure))},function(e){console.log(e)})["finally"](function(){t.cardsLoaded=!0}),$("#key_modal").on("shown.bs.modal",function(){t.productDetails.p_type&&(1==t.productDetails.p_type.data?$(".offer-price").prop("disabled",!0):$(".offer-price").prop("disabled",!1))}),$("#key_modal").modal("show")}},t.viewUser=function(e){a.path("/user").search({u:e})},t.getNumber=function(e){return new Array(e)},t.openShareModal=function(){$("#share_modal").modal("show")},t.loginCheck=function(){return r.get("sellyxtoken")?void 0:(d.confirm("Oops it looks like you are not logged in to use this feature. Please login or sign up for a new account.").then(function(){if(a.search()){var e="?";angular.forEach(a.search(),function(t,o){e+=""+o+"="+t+"&"})}$window.location.href="https://auth.sellyx.com/login?service=www&redirection="+a.path()+e}),$("#alertify-ok").html("Login / Sign Up"),!0)},t.submitForm=function(){if(parseFloat(t.offer.price)<.5)return void l.add({text:"The lowest offer you can make for any item is $0.50",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});t.cardError="";var o=$("#payment-form"),s=o.find("button").html();return t.purchasing=!0,o.find("button").html('<i class="fa fa-spinner fa-pulse"></i>').prop("disabled",!0),Stripe.card.createToken(o,function(r,a){if(console.log(a),a.error)o.find("button").html(s).prop("disabled",!1),t.purchasing=!1,t.$apply(function(){t.cardError="*"+a.error.message});else{var i=t.offer.price?t.offer.price:t.priceConversion,n=t.offer.qty&&t.offer.qty>1?t.offer.qty:"1";t.amount=e.currencySymbol+t.fixedNumber(i*n*1.03,2);var l={id:t.productDetails.id,amount:i*n*1.03,quantity:n,transactions:[{amount:t.fixedNumber(i*n*1.03,2),type:"stripe",token:a.id}]},u={method:"POST",url:"listings/a/order/authorize",data:l,failure_message:!0};c.getapi(u).then(function(e){e.success?(console.log(e.success.id),t.offer.price<t.priceConversion?t.bestOffer=!0:t.bestOffer=!1,t.purchased=!0):(console.log(e.failure),t.cardError="*"+e.failure.msg),t.purchasing=!1,o.find("button").html(s).prop("disabled",!1)},function(e){t.purchasing=!1,o.find("button").html(s).prop("disabled",!1),console.log(e)})}}),!1},t.savedCardPurchase=function(){if(parseFloat(t.offer.price)<.5)return void l.add({text:"The lowest offer you can make for any item is $0.50",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});if(t.purchasing=!0,""==t.cardId)return l.add({text:"You must select a saved card.",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"}),void(t.purchasing=!1);var o=t.offer.price?t.offer.price:t.priceConversion,s=t.offer.qty&&t.offer.qty>1?t.offer.qty:"1";t.amount=e.currencySymbol+t.fixedNumber(o*s*1.03,2);var r={id:t.productDetails.id,amount:o*s*1.03,quantity:s,transactions:[{amount:t.fixedNumber(o*s*1.03,2),type:"stripe",card:t.cardId}]},a={method:"POST",url:"listings/a/order/authorize",data:r,failure_message:!0};c.getapi(a).then(function(e){e.success?(console.log(e.success.id),t.offer.price<t.priceConversion?t.bestOffer=!0:t.bestOffer=!1,t.purchased=!0):(console.log(e.failure),t.cardError="*"+e.failure.msg),t.purchasing=!1},function(e){t.purchasing=!1})},t.sellyxPay=function(e){if(parseFloat(t.offer.price)<.5)return void l.add({text:"The lowest offer you can make for any item is $0.50",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});t.purchasing=!0,t.sellyxError="";var o=t.offer.price?t.offer.price:t.productDetails.price.data,s=t.offer.qty&&t.offer.qty>1?t.offer.qty:"1";t.amount="$"+t.fixedNumber(o*s,2);var r={id:t.productDetails.id,amount:o*s,quantity:s,transactions:[{amount:t.fixedNumber(o*s,2),type:"sellyx"}]},a={method:"POST",url:"listings/a/order/authorize",data:r,button:angular.element($(e.currentTarget)),failure_message:!0,custom_currency:!0};c.getapi(a).then(function(e){e.success?(console.log(e.success.id),t.purchasing=!1,t.purchased=!0):(console.log(e.failure),t.purchasing=!1,t.sellyxError="*"+e.failure.msg)},function(e){t.purchasing=!1,console.log(e)})},t.sendMessage=function(e){if(""==$(".message").val())return void l.add({text:"You must submit a message",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"});var o={method:"POST",url:"messages/a/upsert",data:{message:$("#output").text(),subject:"Listing: "+t.productDetails.title,listing:t.productDetails.id},button:angular.element($(e.currentTarget))};c.getapi(o).then(function(e){e.success?($("#message_modal").modal("hide"),l.add({text:"Your message was sent",title:"Success",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Success.png"})):console.log(e.failure)},function(e){console.log(e)})},t.watchListing=function(e,o){if(!t.loginCheck()){t.following?t.following=!1:t.following=!0;var s={method:"POST",url:"listings/a/follow",data:{id:e,add:t.following}};c.getapi(s).then(function(e){e.success?console.log(e.success):console.log(e.failure)},function(e){console.log(e)})}},t.favoriteListing=function(e,o){if(!t.loginCheck()){t.favorite?t.favorite=!1:t.favorite=!0;var s={method:"POST",url:"listings/a/favorite",data:{id:e,add:t.favorite}};c.getapi(s).then(function(e){e.success?console.log(e.success):console.log(e.failure)},function(e){console.log(e)})}},t.flagListing=function(e,o){t.loginCheck()||d.confirm("Are you sure you would like to flag this listing?").then(function(){if(t.productDetails.flags)return void(t.checkId(t.userInfo.id,t.productDetails.flags.entities)&&l.add({text:"You have already flagged this listing.",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"}));var o={method:"POST",url:"listings/a/flag",data:{id:e}};c.getapi(o).then(function(e){e.success?l.add({text:"This listing has been flagged.",title:"Success",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Success.png"}):console.log(e.failure)},function(e){console.log(e)})})},t.checkId=function(e,t){var o=t.some(function(t){return t.id===e});return o?!0:!1},t.switchPay=function(){t.productDetails&&(1==t.productDetails.p_type.data&&s(function(){$(".offer-price").prop("disabled",!0)}),t.productDetails&&(t.sellyxPayOption?(t.sellyxPayOption=!1,t.offer.price=t.priceConversion):(t.sellyxPayOption=!0,t.offer.price=t.productDetails.price.data.toFixed(2))))},t.newCard=function(){t.addCard?t.addCard=!1:t.addCard=!0},t.selectCard=function(e){var o=angular.element($(e.currentTarget));t.cardId=o.data("card"),o.hasClass("selected-card")?(o.removeClass("selected-card"),t.cardId=""):($(".selected-card").removeClass("selected-card"),o.addClass("selected-card"))},t.loginCheck=function(){return r.get("sellyxtoken")&&r.getObject("userInfo")?void 0:($("#login_modal").modal("show"),t.url=encodeURIComponent(a.url()),!0)},t.fixedNumber=function(e,t){return(+(Math.round(+(e+"e"+t))+"e"+-t)).toFixed(t)},t.priceError=function(e){return t.offer.price.length<2?void("."==t.offer.price&&(t.offer.price="0.")):(isNaN(parseFloat(t.offer.price*t.offer.qty))&&(t.offer.price="",l.add({text:"Please enter a valid number.",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"})),void(t.offer.price.length<3||e.keyCode>=48&&e.keyCode<=57&&parseFloat(t.offer.price)<.5&&(t.offer.price="",l.add({text:"The lowest offer you can make for any item is $0.50",title:"Error",image:"https://sellyx-ecom.s3-us-west-1.amazonaws.com/Failure.png"}))))}}]);